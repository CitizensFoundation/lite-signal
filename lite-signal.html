<script>
  (function() {
    /**
    `lite-signal` provides basic publish-subscribe functionality as a Custom Element.

    Note: avoid using `lite-signal` whenever you can use
    a controller (parent element) to mediate communication instead.

    To send a signal, fire a custom event of type `lite-signal`, with
    a detail object containing `name` and `data` fields.

        this.fire('lite-signal', {name: 'hello', data: null});

    To receive a signal, listen for `lite-signal-<name>` event on a
    `lite-signal` element.

      <lite-signal on-lite-signal-hello="{{helloSignal}}">

    You can fire a signal event from anywhere, and all
    `lite-signal` elements will receive the event, regardless
    of where they are in DOM.

    @demo demo/index.html
    */

    // private list of subscribers
    var signals = []

    // signal dispatcher
    function notify(name, data) {
      // convert generic-signal event to named-signal event
      var signal = new CustomEvent('lite-signal-' + name, {
        // if signals bubble, it's easy to get confusing duplicates
        // (1) listen on a container on behalf of local child
        // (2) some deep child ignores the event and it bubbles
        //     up to said container
        // (3) local child event bubbles up to container
        // also, for performance, we avoid signals flying up the
        // tree from all over the place
        bubbles: false,
        detail: data
      });
      // dispatch named-signal to all 'signals' instances,
      // only interested listeners will react
      signals.forEach(function(s) {
        s.dispatchEvent(signal);
      });
    }

    class LiteSignal extends HTMLElement {
      connectedCallback() {
        signals.push(this);
      }

      disconnectedCallback() {
        var i = signals.indexOf(this);
        if (i >= 0) {
          signals.splice(i, 1);
        }
      }
    }

    // signal listener at document
    document.addEventListener('lite-signal', function(e) {
      notify(e.detail.name, e.detail.data);
    });
  })();
</script>
